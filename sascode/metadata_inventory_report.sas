/*************************************************************************************************************/
/*  PROGRAM NAME: METADATA_INVENTORY_REPORT   	                                    						 */
/*  DATE CREATED: 31-07-2020                                                      							 */
/*  AUTHOR: GEORGE BEEVERS																					 */
/*  DESCRIPTION: This program utilises a number of macros from Alan Bowe and Michael Larson to return 		 */
/*  information from the metadata server. The process will contain information about jobs, users, roles,	 */
/*  tables, notes, prompts, flows, cubes, stored processes, etc. 											 */
/*  INPUTS: SAS Metadata Server			  |              					                        		 */
/*																											 */
/*  OUTPUTS: Various SAS tables and XLSX Report                                    							 */
/* --------------------------------------------------------------------------------------------------------- */
/*  VERSION CONTROL	                         																 */
/*  Version 	Date 		Name 			Description                                 					 */
/*  1.0 		31-07-2020 	George Beevers  Iniital Release                                					 */
/* --------------------------------------------------------------------------------------------------------- */
/*============================================================================================================*/
/* SETUP REQUIREMENT				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Change as per the setup you have						 													  */
/* Macro Library =  																						  */
/* Report Location =																						  */
/*------------------------------------------------------------------------------------------------------------*/
/*CHANGE PATH*/
/*%let macpath=C:\Users\sukgeb\OneDrive - SAS\Documents\1_Banking\4_Generic_Technical_Support\20_Metadata Inventory\Metadata Inventory Report\Code;*/
/*libname mymacs "&macpath.";*/
/*options mstored sasautos=(sasautos,"&macpath");*/

%include "C:\temp\GIT\macros\*";

/*CHANGE REPORT LOCATION*/
%let report_location=c:\temp;
%put &report_location;

/*============================================================================================================*/
/* =========================================CONTROL FLAGS ====================================================*/
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* Change the flags to N if you want to supress any of the sections								  	  		  */
/* 																											  */
/*------------------------------------------------------------------------------------------------------------*/
%let server_group_flag	=Y;
%let people_group_flag	=Y;
%let data_group_flag	=Y;
%let job_group_flag		=Y;
%let other_group_flag	=Y;
%let xlsx_report_flag	=Y;

/*============================================================================================================*/
/* CREATE DATE MACRO				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Used on the reporting layer to date stamp the file														  */
/*------------------------------------------------------------------------------------------------------------*/
%let todaysDate = %sysfunc(today(), yymmddn8.);
%put &todaysDate;

/*============================================================================================================*/
/*  ####   ######  #####   #    #  ######  #####	|Repositories											  */
/* #       #       #    #  #    #  #       #    #	|Server Context											  */
/*  ####   #####   #    #  #    #  #####   #    #	|														  */
/*      #  #       #####   #    #  #       #####	|														  */
/* #    #  #       #   #    #  #   #       #   #	|														  */
/*  ####   ######  #    #    ##    ######  #    #	|														  */
/*============================================================================================================*/
/**************************************************************************************************************/
/* 										START SECTION                     								  	  */
/**************************************************************************************************************/
%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
/*============================================================================================================*/
/* EXTRACT REPOSITORIES				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information about availabel repositories (Foundation, etc)										  */
/*------------------------------------------------------------------------------------------------------------*/
			%mm_getrepos(outds=work.mm_G101_repos);

/*============================================================================================================*/
/* EXTRACT SERVER CONTEXTS			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract availabel server contexts such as SASAP, SASMETA, etc											  */
/*------------------------------------------------------------------------------------------------------------*/
			%mm_getservercontexts(outds=mm_G102_server_context);

/**************************************************************************************************************/
/* 										END SECTION                     								  	  */
/**************************************************************************************************************/
/*============================================================================================================*/
/* EXTRACT SERVER DETAILS			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all server details from metadata											  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_server_architecture(table=mm_G103_server_architect);
%end;
%else
	%do;
		%PUT "FLAG SET TO N SO EXCLUDED FROM THE RUN";
		%put "NOT SELECTED FOR PROCESSING";
		%puT "CHANGE FLAG TO Y TO ALLOW PROCESSING";
	%end;
%mend;

%report_flag(flag=&server_group_flag.);

/*============================================================================================================*/
/* #####   ######   ####   #####   #       ######	|Groups													  */
/* #    #  #       #    #  #    #  #       #		|Users													  */
/* #    #  #####   #    #  #    #  #       #####	|Roles													  */
/* #####   #       #    #  #####   #       #		|AuthDomain												  */
/* #       #       #    #  #       #       #		|														  */
/* #       ######   ####   #       ######  ######	|														  */
/*============================================================================================================*/
/**************************************************************************************************************/
/* 										START SECTION                     								  	  */
/**************************************************************************************************************/
%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
/*============================================================================================================*/
/* EXTRACT METADATA GROUPS			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract metadata groups																					  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractgroups(Table=mm_G201_groups);

/*============================================================================================================*/
/* EXTRACT ALL USERS				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all users from metadata and show the groups they are in.											  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractusers(Table=mm_G202_users);

/*============================================================================================================*/
/* EXTRACT ROLES IN METADATA		                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all roles held in metadata																		  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractroles(Table=mm_G203_roles);

/*============================================================================================================*/
/* EXTRACT AUTHDOMAIN				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information from metadata about AuthDomains. Results will depend on system access and encoded	  */
/* passwords may be present. Sytem level password security policies will determine what is shown. The 		  */
/* OMACONFIG.XML file will show the system policy for the metadata sever.									  */
/*------------------------------------------------------------------------------------------------------------*/
			%mm_getauthinfo(outds=mm_G204_authinfo);
		%end;
	%else
		%do;
			%PUT "FLAG SET TO N SO EXCLUDED FROM THE RUN";
			%put "NOT SELECTED FOR PROCESSING";
			%puT "CHANGE FLAG TO Y TO ALLOW PROCESSING";
		%end;
%mend;

%report_flag(flag=&people_group_flag.);

/**************************************************************************************************************/
/* 										END SECTION                     								  	  */
/**************************************************************************************************************/
/*============================================================================================================*/
/* #####     ##     #####    ##		|Libraries																  */
/* #    #   #  #      #     #  #	|Directories															  */
/* #    #  #    #     #    #    #	|External Files															  */
/* #    #  ######     #    ######	|Tables																	  */
/* #    #  #    #     #    #    #	|Folders   																  */
/* #####   #    #     #    #    #	|																		  */
/*============================================================================================================*/
/**************************************************************************************************************/
/* 										START SECTION                     								  	  */
/**************************************************************************************************************/
%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
/*============================================================================================================*/
/* EXTRACT LIBRARIES				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all libraries (libnames) with fully qualified paths												  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractlibraries(Table=mm_G301_libraries);

/*============================================================================================================*/
/* EXTARCT DIRECTORIES				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Returns all registered directories from metadata															  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractdirectories(Table=mm_G302_directories);

/*============================================================================================================*/
/* EXTRACT EXTERNAL FILES			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information about all external files used in DIS													  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractexternalfiles(Table=mm_G303_externalFiles);

/*============================================================================================================*/
/* EXTRACT ALL TABLES				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all registered tables in metadata																  */
/*------------------------------------------------------------------------------------------------------------*/
/*EXTRACT ALL TABLES																	*/
			%meta_extracttables(Table=mm_G304_tables);

/*============================================================================================================*/
/* EXTRACT METADATA FOLDERS			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all metadata folders																				  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractfolders(Table=mm_G305_folders);
		%end;
	%else
		%do;
			%PUT "FLAG SET TO N SO EXCLUDED FROM THE RUN";
			%put "NOT SELECTED FOR PROCESSING";
			%puT "CHANGE FLAG TO Y TO ALLOW PROCESSING";
		%end;
%mend;

%report_flag(flag=&data_group_flag.);

/**************************************************************************************************************/
/* 										END SECTION                     								  	  */
/**************************************************************************************************************/
/*============================================================================================================*/
/*      #   ####   #####    ####	|Jobs & Tables					|User Written Transformations			  */
/*      #  #    #  #    #  #		|Jobs							|										  */
/*      #  #    #  #####    ####	|Jobs (Deployed)				|										  */
/*      #  #    #  #    #       #	|Job Transformations			|										  */
/* #    #  #    #  #    #  #    #	|Job Notes						|										  */
/*  ####    ####   #####    ####	|Job Prompts					|										  */
/*============================================================================================================*/
/**************************************************************************************************************/
/* 										START SECTION                     								  	  */
/**************************************************************************************************************/
%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
/*============================================================================================================*/
/* EXTRACT JOBS AND TABLES			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all jobs and tables 																				  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractjobtables(Table=mm_G401_JobTables);

/*============================================================================================================*/
/* EXTRACT ALL JOB INFORMATION		                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract job information from metadata. This will include step names, taget and source tables, librefs,	  */
/* physical tables, step number in the job and transformation type											  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractjob(table=mm_G402_jobs);

/*============================================================================================================*/
/* EXTRACT ALL JOBS, INCLUDING DEPLOYED STATUS                             								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extracts job information relating to deployment status. Details shown on jobs which have been deployed to  */
/* the batch server for processing(deploy job in DIS option)												  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractjobs(table=MM_G403_ALL_DEP_JOBS);

/*============================================================================================================*/
/* EXTRACT JOB TRANSFORMATIONS		                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract job information showing transformations. Report shows the source and taget tables along with 	  */
/* every transformation (FileReader, SASExtract, etc)														  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractjobtransformations(Table=mm_G404_JobTransformations);

/*============================================================================================================*/
/* EXTRACT JOB NOTES				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract DIS job notes																					  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractnotes(OutDsn=mm_G405_Notes);

/*============================================================================================================*/
/* EXTRACT JOB PROMPTS				                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract job prompts																						  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractprompts(Table=mm_G406_Prompts);

/*============================================================================================================*/
/* EXTRACT USER WRITTEN TRANSFORMATIONS                                   								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all user written transformations																	  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractuwtransformations(Table=mm_G407_UWTransformations);
		%end;
	%else
		%do;
			%PUT "FLAG SET TO N SO EXCLUDED FROM THE RUN";
			%put "NOT SELECTED FOR PROCESSING";
			%puT "CHANGE FLAG TO Y TO ALLOW PROCESSING";
		%end;
%mend;

%report_flag(flag=&job_group_flag.);

/**************************************************************************************************************/
/* 										END SECTION                     								  	  */
/**************************************************************************************************************/
/*============================================================================================================*/
/*  ####    #####  #    #  ######  #####	|Enterprise Miner												  */
/* #    #     #    #    #  #       #    #	|Cubes														      */
/* #    #     #    ######  #####   #    #	|Visual Analytics												  */
/* #    #     #    #    #  #       #####	|Information Maps												  */
/* #    #     #    #    #  #       #   #	|Stored Processes												  */
/*  ####      #    #    #  ######  #    #	|Reports														  */
/*============================================================================================================*/
/**************************************************************************************************************/
/* 										START SECTION                     								  	  */
/**************************************************************************************************************/
%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
/*============================================================================================================*/
/* EXTRACT ENTERPRISE MINER MODEL INFORMATION                              								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information related to EMiner models registered in metadata										  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractminingresults(Table=mm_G501_MiningResults);

/*============================================================================================================*/
/* EXTRACT CUBES					                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract all information about cubes held in metadata														  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractcubes(Table=mm_G502_Cubes);

/*============================================================================================================*/
/* EXTRACT VISUAL ANALYTICS INFORMATION                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information about Visual Analytics reports														  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractvaexplorations(Table=mm_G503_VAExplorations);

/*============================================================================================================*/
/* EXTRACT INFORMATION MAPS			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Exttract information maps from metadata																	  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractinfomaps(Table=mm_G504_InfoMaps);

/*============================================================================================================*/
/* EXTRACT STORED PROCESSES			                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information about stored processes																  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractstoredprocesses(Table=mm_G505_StoredProcesses);

/*============================================================================================================*/
/* EXTRACT REPORTS					                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Extract information about reports in metadata															  */
/*------------------------------------------------------------------------------------------------------------*/
			%meta_extractreports(Table=mm_G506_Reports);

			/**************************************************************************************************************/
			/* 										END SECTION                     								  	  */
			/**************************************************************************************************************/
		%end;
	%else
		%do;
			%PUT "FLAG SET TO N SO EXCLUDED FROM THE RUN";
			%put "NOT SELECTED FOR PROCESSING";
			%puT "CHANGE FLAG TO Y TO ALLOW PROCESSING";
		%end;
%mend;

%report_flag(flag=&other_group_flag.);

/*============================================================================================================*/
/* GENERATE REPORT					                                    								  	  */
/*============================================================================================================*/
/*------------------------------------------------------------------------------------------------------------*/
/* DESCRIPTION                                                   								  	  		  */
/* Export information from metadata to XLSX using the XLSX Engine in SAS									  */
/*   																										  */
/*------------------------------------------------------------------------------------------------------------*/
/*No need to tranwrd . to _ as works fine in windows*/
/*%let m_server= %sysfunc(tranwrd(%sysfunc(getoption(METASERVER,EXPAND)),.,_));*/
%let m_server=%sysfunc(getoption(METASERVER,EXPAND));
%put &m_server;

%macro report_flag(flag=N);
	/*%let server_flag=N;*/
	%if "&flag."="Y" %then
		%do;
			proc datasets lib=work noprint;
				delete repos;
				delete _subjobs;
				delete _jobs;
				delete MM_G204_AUTHINFO0;
				delete MM_G204_AUTHINFO_DOM;
			quit;

			proc sql noprint;
				select memname, count(*) into:memname1 - ,:obsnum TRIMMED
					from dictionary.tables
						where libname = 'WORK' and memname contains "MM_G" 
							order by memname;
			quit;

/*EXPORT TO XLSX*/
			libname xlout XLSX "&report_location.\Meta_Inventory_&m_server._&todaysdate..xlsx";

%macro export_xlsx(fname=);
	/*Create INDEX Page*/
	proc sql;
		create table  xlout.INDEX as 
			select memname as Sheet_Name
				,crdate as Creation_Date
				,nobs as Observations
			from dictionary.tables
				where libname = 'WORK' and memname contains "MM_G";
	quit;

	%do i=1 %to &obsnum.;

		data xlout.&&memname&i.;
			set &&memname&i.;
		run;

	%end;

%mend;

%export_xlsx;
libname xlout clear;

/*Tidy up .BAK (Backup Files)*/
%macro xlsx_bak_delete(file=) / des='Delete backup spreadsheets';
	option mprint notes;

	data _null_;
		fname = 'todelete';
		rc = filename(fname, "&file..xlsx.bak");
		rc = fdelete(fname);
		rc = filename(fname);
	run;

%mend xlsx_bak_delete;

%xlsx_bak_delete(file=&report_location.\Meta_Inventory_&m_server._&todaysdate.);
%end;
%else
	%do;
		%PUT "FLAG SET TO &server_group_flag SO EXCLUDED FROM THE RUN";
		%put "NOT SELECTED FOR PROCESSING";
		%puT "CHANGE SERVER_GROUP_FLAG TO Y TO ALLOW PROCESSING";
	%end;

%mend;

%report_flag(flag=&xlsx_report_flag.);

/*Clean Up */
proc datasets lib=work;
mm_G:;
run;
